name: Build and Release APK

on:
  push:
    branches: [ main, refactoring/phase-4.5-architecture ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Android SDK and Build Tools
      run: |
        # Android SDK installieren
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools/latest
        mv cmdline-tools/* $HOME/android-sdk/cmdline-tools/latest/

        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin

        # SDK Komponenten installieren
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-33" "build-tools;33.0.2"

    - name: Download Room Dependencies
      run: |
        mkdir -p libs

        # Download Room libraries from Google Maven
        echo "Downloading Room dependencies from dl.google.com..."

        # Room compiler (JAR - annotation processor)
        wget -q https://dl.google.com/dl/android/maven2/androidx/room/room-compiler/2.6.0/room-compiler-2.6.0.jar \
          -O libs/room-compiler.jar

        # Room compiler-processing (JAR - required by room-compiler)
        wget -q https://dl.google.com/dl/android/maven2/androidx/room/room-compiler-processing/2.6.0/room-compiler-processing-2.6.0.jar \
          -O libs/room-compiler-processing.jar

        # Room common (JAR - shared interfaces)
        wget -q https://dl.google.com/dl/android/maven2/androidx/room/room-common/2.6.0/room-common-2.6.0.jar \
          -O libs/room-common.jar

        # Room runtime (AAR - need to extract classes.jar)
        wget -q https://dl.google.com/dl/android/maven2/androidx/room/room-runtime/2.6.0/room-runtime-2.6.0.aar \
          -O libs/room-runtime.aar
        unzip -q libs/room-runtime.aar -d libs/room-runtime-extracted
        mv libs/room-runtime-extracted/classes.jar libs/room-runtime.jar
        rm -rf libs/room-runtime.aar libs/room-runtime-extracted

        # AndroidX annotation (JAR)
        wget -q https://dl.google.com/dl/android/maven2/androidx/annotation/annotation/1.7.0/annotation-1.7.0.jar \
          -O libs/androidx-annotation.jar

        # AndroidX SQLite (AAR - need to extract classes.jar)
        wget -q https://dl.google.com/dl/android/maven2/androidx/sqlite/sqlite/2.4.0/sqlite-2.4.0.aar \
          -O libs/androidx-sqlite.aar
        unzip -q libs/androidx-sqlite.aar -d libs/sqlite-extracted
        mv libs/sqlite-extracted/classes.jar libs/androidx-sqlite.jar
        rm -rf libs/androidx-sqlite.aar libs/sqlite-extracted

        echo "Room dependencies downloaded and extracted successfully"
        ls -lh libs/*.jar

    - name: Build APK
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_JAR=$ANDROID_SDK_ROOT/platforms/android-33/android.jar
        export ROOM_CLASSPATH="libs/room-runtime.jar:libs/room-common.jar:libs/androidx-annotation.jar:libs/androidx-sqlite.jar"
        export ROOM_PROCESSOR="libs/room-compiler.jar:libs/room-compiler-processing.jar:libs/room-common.jar"

        # Build-Verzeichnisse erstellen
        mkdir -p compiled_res gen classes generated

        # Ressourcen kompilieren
        $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt2 compile \
          res/values/strings.xml \
          res/layout/activity_main.xml \
          res/layout/dialog_settings.xml \
          res/layout/dialog_logs.xml \
          res/layout/activity_tasks.xml \
          res/layout/task_list_item.xml \
          res/layout/dialog_add_task.xml \
          res/layout/dialog_completion.xml \
          res/menu/main_menu.xml \
          -o compiled_res/

        # Ressourcen verlinken
        $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt2 link \
          -o app_unsigned.apk \
          -I $ANDROID_JAR \
          --manifest AndroidManifest.xml \
          -R compiled_res/*.flat \
          --java gen/ \
          --auto-add-overlay

        # Java kompilieren (Step 1: Room Annotation Processing)
        echo "=== Step 1: Room Annotation Processing ==="

        javac -source 8 -target 8 \
          -d classes/ \
          -s generated/ \
          -classpath $ANDROID_JAR:$ROOM_CLASSPATH \
          -processorpath $ROOM_PROCESSOR \
          -processor androidx.room.RoomProcessor \
          src/com/secretary/features/tasks/data/TaskEntity.java \
          src/com/secretary/features/tasks/data/TaskDao.java \
          src/com/secretary/features/statistics/data/CompletionEntity.java \
          src/com/secretary/features/statistics/data/CompletionDao.java \
          src/com/secretary/shared/database/TaskDatabase.java \
          2>&1 || echo "Room annotation processing failed - continuing anyway"

        echo "=== Generated Room files ==="
        find generated -name "*.java" || echo "No files generated"

        # Java kompilieren (Step 2: All source files including generated code)
        echo "=== Step 2: Compiling all source files ==="
        ls -la src/com/secretary/ || true
        ls -la gen/com/secretary/helloworld/ || true

        javac -source 8 -target 8 \
          -d classes/ \
          -classpath $ANDROID_JAR:$ROOM_CLASSPATH \
          -sourcepath src/:gen/:generated/ \
          src/com/secretary/app/MainActivity.java \
          src/com/secretary/core/logging/AppLogger.java \
          src/com/secretary/core/logging/HttpLogServer.java \
          src/com/secretary/core/network/UpdateChecker.java \
          src/com/secretary/core/network/UpdateInstaller.java \
          src/com/secretary/shared/database/DatabaseConstants.java \
          src/com/secretary/Task.java \
          src/com/secretary/TaskStatistics.java \
          src/com/secretary/TaskDatabaseHelper.java \
          src/com/secretary/TaskListAdapter.java \
          src/com/secretary/TaskFilterManager.java \
          src/com/secretary/TaskDialogHelper.java \
          src/com/secretary/TaskActivity.java \
          gen/com/secretary/helloworld/R.java \
          $(find generated -name "*.java" 2>/dev/null || echo "") \
          2>&1 || echo "COMPILATION FAILED"

        echo "=== Compilation finished ==="
        ls -la classes/com/secretary/helloworld/ || echo "No class files generated"

        # DEX erstellen
        find classes -name "*.class" -print
        $ANDROID_SDK_ROOT/build-tools/33.0.2/d8 \
          --lib $ANDROID_JAR \
          --release \
          --output . \
          $(find classes -name "*.class")

        # DEX zur APK hinzufÃ¼gen
        zip -uj app_unsigned.apk classes.dex

        # APK alignieren
        $ANDROID_SDK_ROOT/build-tools/33.0.2/zipalign -v -p 4 \
          app_unsigned.apk \
          app_aligned.apk

    - name: Sign APK
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk

        # Decode keystore from GitHub secret
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore

        # APK signieren mit permanentem Keystore
        $ANDROID_SDK_ROOT/build-tools/33.0.2/apksigner sign \
          --ks release.keystore \
          --ks-key-alias release \
          --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
          --key-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
          --out AISecretary-signed.apk \
          app_aligned.apk

    - name: Extract version
      id: version
      run: |
        VERSION=$(grep 'android:versionName=' AndroidManifest.xml | sed 's/.*versionName="\([^"]*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: AI Secretary v${{ steps.version.outputs.version }}
        body: |
          Automated build of AI Secretary

          Version: ${{ steps.version.outputs.version }}
          Built on: ${{ github.event.head_commit.timestamp }}
          Commit: ${{ github.sha }}

          ## Changes
          ${{ github.event.head_commit.message }}

          ## Installation
          1. Download AISecretary-signed.apk
          2. Install on your Android device
          3. The app will auto-update from future releases
        files: AISecretary-signed.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
