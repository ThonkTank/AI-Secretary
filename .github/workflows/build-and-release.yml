name: Build and Release APK

on:
  push:
    branches: [ main, refactoring/phase-4.5-architecture ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Android SDK and Build Tools
      run: |
        # Android SDK installieren
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools/latest
        mv cmdline-tools/* $HOME/android-sdk/cmdline-tools/latest/

        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin

        # SDK Komponenten installieren
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-33" "build-tools;33.0.2"

    - name: Build APK
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_JAR=$ANDROID_SDK_ROOT/platforms/android-33/android.jar

        # Build-Verzeichnisse erstellen
        mkdir -p compiled_res gen classes

        # Ressourcen kompilieren
        $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt2 compile \
          res/values/strings.xml \
          res/layout/activity_main.xml \
          res/layout/dialog_settings.xml \
          res/layout/dialog_logs.xml \
          res/layout/activity_tasks.xml \
          res/layout/task_list_item.xml \
          res/layout/dialog_add_task.xml \
          res/layout/dialog_completion.xml \
          res/menu/main_menu.xml \
          -o compiled_res/

        # Ressourcen verlinken
        $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt2 link \
          -o app_unsigned.apk \
          -I $ANDROID_JAR \
          --manifest AndroidManifest.xml \
          -R compiled_res/*.flat \
          --java gen/ \
          --auto-add-overlay

        # Java kompilieren
        echo "=== Starting Java compilation ==="
        ls -la src/com/secretary/ || true
        ls -la gen/com/secretary/helloworld/ || true

        javac -source 8 -target 8 \
          -d classes/ \
          -classpath $ANDROID_JAR \
          -sourcepath src/:gen/ \
          src/com/secretary/app/MainActivity.java \
          src/com/secretary/core/logging/AppLogger.java \
          src/com/secretary/core/logging/HttpLogServer.java \
          src/com/secretary/core/network/UpdateChecker.java \
          src/com/secretary/core/network/UpdateInstaller.java \
          src/com/secretary/shared/database/DatabaseConstants.java \
          src/com/secretary/Task.java \
          src/com/secretary/TaskStatistics.java \
          src/com/secretary/TaskDatabaseHelper.java \
          src/com/secretary/TaskListAdapter.java \
          src/com/secretary/TaskFilterManager.java \
          src/com/secretary/TaskDialogHelper.java \
          src/com/secretary/TaskActivity.java \
          gen/com/secretary/helloworld/R.java \
          2>&1 || echo "COMPILATION FAILED"

        echo "=== Compilation finished ==="
        ls -la classes/com/secretary/helloworld/ || echo "No class files generated"

        # DEX erstellen
        find classes -name "*.class" -print
        $ANDROID_SDK_ROOT/build-tools/33.0.2/d8 \
          --lib $ANDROID_JAR \
          --release \
          --output . \
          $(find classes -name "*.class")

        # DEX zur APK hinzufÃ¼gen
        zip -uj app_unsigned.apk classes.dex

        # APK alignieren
        $ANDROID_SDK_ROOT/build-tools/33.0.2/zipalign -v -p 4 \
          app_unsigned.apk \
          app_aligned.apk

    - name: Sign APK
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk

        # Decode keystore from GitHub secret
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore

        # APK signieren mit permanentem Keystore
        $ANDROID_SDK_ROOT/build-tools/33.0.2/apksigner sign \
          --ks release.keystore \
          --ks-key-alias release \
          --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
          --key-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
          --out AISecretary-signed.apk \
          app_aligned.apk

    - name: Extract version
      id: version
      run: |
        VERSION=$(grep 'android:versionName=' AndroidManifest.xml | sed 's/.*versionName="\([^"]*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: AI Secretary v${{ steps.version.outputs.version }}
        body: |
          Automated build of AI Secretary

          Version: ${{ steps.version.outputs.version }}
          Built on: ${{ github.event.head_commit.timestamp }}
          Commit: ${{ github.sha }}

          ## Changes
          ${{ github.event.head_commit.message }}

          ## Installation
          1. Download AISecretary-signed.apk
          2. Install on your Android device
          3. The app will auto-update from future releases
        files: AISecretary-signed.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
